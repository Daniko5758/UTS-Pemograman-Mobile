@page "/courses"
@inject ApiService Api
@using MyTraining.Shared.Models
@using MyTraining.Shared.Services

<h3>Courses</h3>

<div class="input-group mb-3">
    <input @bind="search" @bind:event="oninput" class="form-control" placeholder="Search courses..." />
    <button class="btn btn-primary" @onclick="Search">Search</button>
    <button class="btn btn-success" @onclick="New">New Course</button>
</div>

@if (loading)
{
    <p>Loading...</p>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Cover</th>
                <th>Title</th>
                <th>Description</th>
                <th>Trainer</th>
                <th>Duration</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in courses)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(c.CoverImageUrl))
                        {
                            <img src="@(Api.BaseUrl.TrimEnd('/') + c.CoverImageUrl)" class="img-thumbnail" style="width: 100px; height: auto;" alt="Cover" />
                        }
                    </td>
                    <td>@c.Title</td>
                    <td>@c.Description</td>
                    <td>@c.Trainer?.FullName</td>
                    <td>@c.DurationMinutes min</td>
                    <td>@c.Price</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => Edit(c.Id)">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(c.Id)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (editing)
{
    <div class="card mt-4">
        <div class="card-header">
            <h4>@(currentCourse.Id == 0 ? "New Course" : "Edit Course")</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Title</label>
                    <input class="form-control" @bind="currentCourse.Title" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Trainer</label>
                    <select class="form-select" @bind="currentCourse.TrainerId">
                        <option value="0">-- Select Trainer --</option>
                        @foreach (var t in trainers)
                        {
                            <option value="@t.Id">@t.FullName</option>
                        }
                    </select>
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" rows="3" @bind="currentCourse.Description"></textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Duration (minutes)</label>
                    <input type="number" class="form-control" @bind="currentCourse.DurationMinutes" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Price</label>
                    <input type="number" class="form-control" step="0.01" @bind="currentCourse.Price" />
                </div>

                <div class="col-12 mb-3">
                    <label class="form-label">Cover Image</label>
                    <InputFile OnChange="OnImageSelected" class="form-control" accept="image/png, image/jpeg" />
                </div>
                @if (uploading)
                {
                    <div class="col-12 mb-3"><div class="spinner-border spinner-border-sm" role="status"></div> Uploading...</div>
                }
                @if (!string.IsNullOrEmpty(currentCourse.CoverImageUrl))
                {
                    <div class="col-12 mb-3">
                        <label>Image Preview:</label>
                        <div>
                            <img src="@(Api.BaseUrl.TrimEnd('/') + currentCourse.CoverImageUrl)" style="max-width: 200px;" />
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="card-footer text-end">
            <button class="btn btn-secondary me-2" @onclick="Cancel">Cancel</button>
            <button class="btn btn-success" @onclick="Save" disabled="@uploading">@(!uploading ? "Save" : "Saving...")</button>
        </div>
    </div>
}

@code {
    List<Course> courses = new();
    List<Trainer> trainers = new();
    bool loading = true;
    bool editing = false;
    string? search;
    Course currentCourse = new();
    bool uploading = false;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    async Task Load()
    {
        loading = true;
        trainers = await Api.GetTrainers() ?? new();
        courses = await Api.GetCourses() ?? new();
        loading = false;
    }

    async Task Search()
    {
        loading = true;
        courses = await Api.GetCourses(search) ?? new();
        loading = false;
    }

    void New() { currentCourse = new Course(); editing = true; }
    async Task Edit(int id) { var c = await Api.GetCourse(id); if (c != null) { currentCourse = c; editing = true; } }
    async Task Save()
    {
        if (currentCourse.Id == 0) await Api.CreateCourse(currentCourse);
        else await Api.UpdateCourse(currentCourse.Id, currentCourse);
        editing = false;
        await Load();
    }
    void Cancel() => editing = false;
    async Task Delete(int id) { await Api.DeleteCourse(id); await Load(); }

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        uploading = true;
        StateHasChanged();
        var returnedImagePath = await Api.UploadCourseImageAsync(file);
        if (returnedImagePath != null)
        {
            currentCourse.CoverImageUrl = returnedImagePath;
        }
        uploading = false;
        StateHasChanged();
    }
}